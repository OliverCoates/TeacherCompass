{% extends "layout.html" %}

{% block head %}
  <title> Home - Teacher Compass </title>
{% endblock %}

{% block content %}

  <div class="grid-container">
    <!-- Header -->
    <div class="item1">
      <p>You are signed in, welcome {{current_user.name}}. <a href="/home"> Return to homepage </a> </p>
    </div>

    <!-- Left spacer
    <div class="item2"></div>
     -->

    <!-- Image -->
    <div class="item3">
      <canvas id="compassCanvas" width="800" height="562"
      style="border:1px solid #c3c3c3;">
      Your browser does not support the canvas element
      </canvas>
    </div>

    <!-- Text -->
    <div class="item4">
        <div class="teacherSelect">

          <form class="teacherValueSubmit" action="/score" method="POST" novalidate>
          <p style="display:inline"> Select a teacher: </p>  <!-- I don't know why display inline isn't working but the div can't set it so it has to be set manually -->

          <select name="TeacherCode" class="teacherCodeSelect" value="">
            {% for teacher in teachers %}
              <option value="{{teacher}}">{{teacher}}</option>
            {%endfor%}
          </select>

          <input type="submit" value="Submit values">

          <br>

          <p style="display:inline"> X value: </p>
          <input type="number" name="xInput" value="0" min="-10" max="10" step="0.1" class="axis">

          <p style="display:inline"> Y value: </p>
          <input type="number" name="yInput" value="0" min="-10" max="10" step="0.1" class="axis">

          <p style="display:inline"> Z value: </p>
          <input type="number" name="zInput" value="0" min="-10" max="10" step="0.1" class="axis">

          </form>

          <!--- Flask flashing code: --->
          {% with messages = get_flashed_messages(category_filter=['info']) %}
            {% if messages %}
              <ul class=flashes>
              {% for message in messages %}
                <li>{{ message }}</li>
              {% endfor %}
              </ul>
            {% endif %}
          {% endwith %}

        </div>
      <p class="info-text"> Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce quis cursus diam,
        quis porta urna. Sed non sodales diam. Duis finibus velit id semper consectetur.
        Cras ullamcorper, nunc ac tempor gravida, leo neque dapibus leo, vitae sagittis lectus metus
        at arcu. Quisque sit amet lobortis tellus. Phasellus tincidunt est ac lectus consequat,
        vitae posuere lectus luctus. Etiam eget nisi scelerisque, convallis erat quis, rutrum dui.</p>
    </div>

    <!-- Right spacer

    <div class="item5"></div>
    -->

    <!-- Footer -->
    <div class="item6">
      <p class="footer-text"> Made by Oliver Coates (approved by Jayden Ling)</p>
    </div>
  </div>
{% endblock %}

{% block script %}
<script>
  function fetchValues() {
    /* Ask the database for the x, y and z values for the newly selected teacher code */
    const teacher_code = document.querySelector(".teacherCodeSelect").value
    fetch(`/api/score/${teacher_code}`)
      .then(response => response.json())
      .then(data => {
          document.querySelector("[name=xInput]").value = data.x;
          document.querySelector("[name=yInput]").value = data.y;
          document.querySelector("[name=zInput]").value = data.z;
          /* Update the chart */
          axisUpdated()
      });
  }

  document.querySelector(".teacherCodeSelect").addEventListener("change", fetchValues)
  /*Call this when the script is loaded */
  fetchValues()

  console.log("here ");
  const context = document.querySelector("#compassCanvas").getContext("2d");
  const image = new Image();
  image.src = "/static/compass.png";
  image.addEventListener("load", () => {
    context.drawImage(image, 0, 0, 800, 562);
    axisUpdated();
  });

  function axisUpdated() {
    context.clearRect(0, 0, 800, 562);
    context.drawImage(image, 0, 0, 800, 562);
    context.beginPath();
    // arc( x value | y value | diameter | leave everything else)
    const posX = parseFloat(document.querySelector("[name=xInput]").value) * 21.6 + 303;
    const posY = -parseFloat(document.querySelector("[name=yInput]").value) * 21.6 + 281;
    const posZ = parseFloat(document.querySelector("[name=zInput]").value) * 21.6 + 281;
    context.arc(posX, posY, 5, 0, 2 * Math.PI);
    context.arc(681, posZ, 5, 0, 2 * Math.PI);
    context.fillStyle = 'red';
    context.fill();
  }

  document.querySelectorAll(".axis")
    .forEach(input => input.addEventListener("input", (event) => {
      event.target.value = Math.round(event.target.value * 100) / 100  // Round to 2dp

      if (event.target.value < -10) {
        event.target.value = -10
      } else if (event.target.value > 10 ){
        event.target.value = 10
      }
      else if (event.target.value == '')
      {
        event.target.value = 0
      }
      axisUpdated()
    }));

</script>
{% endblock %}
